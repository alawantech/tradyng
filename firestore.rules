rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isBusinessOwner(businessId) {
      return isSignedIn() && 
             exists(/databases/$(database)/documents/businesses/$(businessId)) &&
             get(/databases/$(database)/documents/businesses/$(businessId)).data.ownerId == request.auth.uid;
    }
    
    // Users collection - only admins and the user themselves can read/write
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      // Allow deletion by admin or if no auth context (Cloud Functions with admin SDK)
      allow delete: if isAdmin() || request.auth == null;
    }
    
    // Businesses collection
    match /businesses/{businessId} {
      // Anyone can read business info (for storefront)
      allow read: if true;
      // Only owner can create (during signup)
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // Only owner or admin can update
      allow update: if isBusinessOwner(businessId) || isAdmin();
      // Allow deletion by admin or if no auth context (Cloud Functions with admin SDK)
      allow delete: if isAdmin() || request.auth == null;
      
      // Products subcollection
      match /products/{productId} {
        // Anyone can read products (for storefront)
        allow read: if true;
        // Only business owner or admin can create/update
        allow create, update: if isBusinessOwner(businessId) || isAdmin();
        // Allow deletion by admin or if no auth context (Cloud Functions with admin SDK)
        allow delete: if isBusinessOwner(businessId) || isAdmin() || request.auth == null;
      }
      
      // Orders subcollection
      match /orders/{orderId} {
        // Business owner, admin, or anyone can read (customers need to filter by email)
        // Note: Customers filter by email in the app, so we allow read access
        // In production, you should use a Cloud Function to query customer orders
        allow read: if isBusinessOwner(businessId) || isAdmin() || true;
        // Anyone can create orders (customers placing orders from storefront)
        // Business owner and admin can also create orders
        allow create: if true;
        // Only business owner or admin can update orders
        allow update: if isBusinessOwner(businessId) || isAdmin();
        // Allow deletion by admin or if no auth context (Cloud Functions with admin SDK)
        allow delete: if isAdmin() || request.auth == null;
      }
      
      // Counters subcollection (for order ID generation)
      match /counters/{counterId} {
        // Anyone can read counters (needed for order ID generation)
        allow read: if true;
        // Anyone can update counters (auto-increment for order IDs)
        allow update: if true;
        // Only business owner can create counters
        allow create: if isBusinessOwner(businessId) || isAdmin();
        // Only admin can delete
        allow delete: if isAdmin();
      }
      
      // Customers subcollection
      match /customers/{customerId} {
        // Business owner, admin, or anyone checking if email exists (during login) can read
        // Note: For better security, customer data should be queried by Cloud Function
        // but for MVP we allow read access for customer login flow
        allow read: if isBusinessOwner(businessId) || isAdmin() || true;
        // Anyone can create customer record (during storefront signup/checkout)
        // Business owner and admin can also create/update
        allow create, update: if true;
        // Allow deletion by admin or if no auth context (Cloud Functions with admin SDK)
        allow delete: if isAdmin() || request.auth == null;
        
        // Customer messages subcollection
        match /messages/{messageId} {
          allow read: if isBusinessOwner(businessId) || isAdmin();
          allow create: if isBusinessOwner(businessId) || isAdmin();
          allow update, delete: if isBusinessOwner(businessId) || isAdmin();
        }
      }
      
      // Categories subcollection
      match /categories/{categoryId} {
        allow read: if true; // Anyone can read categories
        allow create, update: if isBusinessOwner(businessId) || isAdmin();
        // Allow deletion by admin or if no auth context (Cloud Functions with admin SDK)
        allow delete: if isBusinessOwner(businessId) || isAdmin() || request.auth == null;
      }
    }
    
    // Customer profiles (global collection) - OLD COLLECTION NAME
    match /customerProfiles/{profileId} {
      // Anyone can read to check if profile exists during login
      // This is safe because sensitive data should be minimal
      allow read: if true;
      // Anyone can create a profile (during signup)
      allow create: if true;
      // Customer can update their own profile, or admin
      allow update: if isOwner(profileId) || isAdmin();
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Customers (global collection) - NEW COLLECTION FOR CUSTOMER PROFILES
    match /customers/{customerId} {
      // Customers can read their own profile
      // Anyone can read to check if profile exists during login
      allow read: if true;
      // Authenticated customers can create their own profile
      // The customer is authenticated when signup happens
      allow create: if isSignedIn() && request.auth.uid == customerId;
      // Customer can update their own profile
      allow update: if isOwner(customerId) || isAdmin();
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Customer Addresses (global collection for customer shipping addresses)
    match /customer_addresses/{addressId} {
      // Customers can read their own addresses
      allow read: if isSignedIn() && resource.data.customerId == request.auth.uid;
      // Customers can create their own addresses
      allow create: if isSignedIn() && request.resource.data.customerId == request.auth.uid;
      // Customers can update their own addresses
      allow update: if isSignedIn() && resource.data.customerId == request.auth.uid;
      // Customers can delete their own addresses
      allow delete: if isSignedIn() && resource.data.customerId == request.auth.uid;
    }
    
    // Affiliates collection
    match /affiliates/{affiliateId} {
      // Admins can read all affiliates
      // Affiliates can only read their own data
      // Allow unauthenticated reads for username availability checking during registration
      allow read: if true; // Allow anyone to read for username availability check and admin access
      // Anyone can create affiliate account (signup) - check firebaseUid field
      allow create: if isSignedIn() && request.resource.data.firebaseUid == request.auth.uid;
      // Any authenticated user can update (for withdrawal processing by admin)
      // TODO: Implement custom claims for proper admin verification
      allow update: if isSignedIn();
      // Any authenticated user can delete (admin check done on client side)
      allow delete: if isSignedIn();
    }
    
    // Referrals collection
    match /referrals/{referralId} {
      // Admins can read all
      // Authenticated users can read all referrals (client-side filters by affiliateId)
      allow read: if isSignedIn();
      // Only system (cloud functions) can create referrals
      allow create: if false; // Must be created by Cloud Function
      // Only admin can update
      allow update: if isAdmin();
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // Withdrawal Requests
    match /withdrawalRequests/{withdrawalId} {
      // Admins can read all
      // Authenticated users can read all withdrawal requests (client-side filters by affiliateId)
      allow read: if isSignedIn();
      // Authenticated users can create withdrawal requests
      allow create: if isSignedIn();
      // Any authenticated user can update (admin check done on client side)
      // TODO: Implement custom claims for proper admin verification
      allow update: if isSignedIn();
      // Any authenticated user can delete (admin check done on client side)
      allow delete: if isSignedIn();
    }
    
    // Products (global collection)
    match /products/{productId} {
      // Anyone can read products (for storefront)
      allow read: if true;
      // Signed-in users can create products
      allow create: if isSignedIn();
      // Product owner or admin can update
      allow update: if isSignedIn() || isAdmin();
      // Allow deletion by signed-in users, admin, or if no auth context (Cloud Functions)
      allow delete: if isSignedIn() || isAdmin() || request.auth == null;
    }
    
    // Orders (global collection)
    match /orders/{orderId} {
      // Anyone can read orders
      allow read: if true;
      // Anyone can create orders (customers placing orders)
      allow create: if true;
      // Signed-in users or admin can update
      allow update: if isSignedIn() || isAdmin();
      // Allow deletion by signed-in users, admin, or if no auth context (Cloud Functions)
      allow delete: if isSignedIn() || isAdmin() || request.auth == null;
    }
    
    // Categories (global collection)
    match /categories/{categoryId} {
      // Anyone can read categories (for storefront)
      allow read: if true;
      // Business owner or admin can create categories
      allow create: if isSignedIn();
      // Business owner or admin can update their own categories
      allow update: if isSignedIn() || isAdmin();
      // Allow deletion by signed-in users, admin, or if no auth context (Cloud Functions)
      allow delete: if isSignedIn() || isAdmin() || request.auth == null;
    }
    
    // Coupons collection
    match /coupons/{couponId} {
      // Anyone can read coupons (to validate during checkout)
      allow read: if true;
      // Admins can create/update/delete any coupons
      // Signed-in users can create coupons (for affiliate registration)
      allow create: if isAdmin() || isSignedIn();
      allow update, delete: if isAdmin();
    }
    
    // Email OTPs (for verification)
    match /emailOtps/{otpId} {
      // No direct access - only Cloud Functions
      allow read, write: if false;
    }
    
    // Password Reset OTPs
    match /passwordResetOtps/{otpId} {
      // No direct access - only Cloud Functions
      allow read, write: if false;
    }
    
    // Analytics (if you add this)
    match /analytics/{document=**} {
      // Only admins can read analytics
      allow read: if isAdmin();
      // No direct writes
      allow write: if false;
    }
    
    // Default deny - any collection not explicitly allowed
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
